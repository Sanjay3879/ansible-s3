---
- name: Install AWS CLI and download S3 file
  hosts: localhost
  connection: local
  gather_facts: false
  become: yes  # ensures tasks requiring root run properly

  vars:
    s3_bucket: "sanjay-3879"
    s3_object: "sanjay.txt"
    download_path: "/home/ec2-user/sanjay.txt"

  tasks:

    - name: Install required packages
      package:
        name:
          - unzip
          - python3
        state: present

    - name: Download AWS CLI v2 zip if not already present
      get_url:
        url: "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip"
        dest: /tmp/awscliv2.zip
        mode: '0644'
      register: awscli_download
      # This avoids re-downloading if the file already exists
      changed_when: awscli_download.changed

    - name: Unzip AWS CLI installer
      unarchive:
        src: /tmp/awscliv2.zip
        dest: /tmp/
        remote_src: yes
      when: awscli_download.changed

    - name: Install AWS CLI
      shell: "/tmp/aws/install"
      args:
        creates: /usr/local/bin/aws

    - name: Clean AWS CLI installer files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/awscliv2.zip
        - /tmp/aws

    - name: Ensure destination directory exists
      file:
        path: "/home/ec2-user"
        state: directory
        mode: '0755'

    - name: Download S3 file
      amazon.aws.aws_s3:
        bucket: "{{ s3_bucket }}"
        object: "{{ s3_object }}"
        dest: "{{ download_path }}"
        mode: get

    - name: Ensure ec2-user owns the S3 file
      file:
        path: "{{ download_path }}"
        owner: ec2-user
        group: ec2-user
        mode: '0644'

